import { useEffect, useMemo, useState } from 'react';
import { Bell } from 'lucide-react';
import { AppNotification, fetchNotifications, markNotificationsAsRead } from '@/utils/notifications';
import { playSound, vibrate } from '@/utils/notifyHelpers';
import { useSheetService } from '@/hooks/useSheetService';
import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip';
import { useNavigate } from 'react-router-dom';
import { stateManager } from '@/lib/stateManager';
import { GoogleSheetsService } from '@/lib/googleSheets';

const STORAGE_KEY = 'crm_notifications_cache_v1';

export default function NotificationBell({ user }: { user: { email?: string } }) {
  // Use hook at top-level per React rules of hooks
  const { service: sheetService } = useSheetService();
  const [notifications, setNotifications] = useState<AppNotification[]>([]);
  const [open, setOpen] = useState(false);
  const [markingRead, setMarkingRead] = useState(false);
  const navigate = useNavigate();

  // hydrate from cache immediately
  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) setNotifications(JSON.parse(raw));
    } catch (error) {
      console.warn('Failed to hydrate notifications cache:', error);
    }
  }, []);

  // Removed invalid hook usage inside effect

  useEffect(() => {
    if (!sheetService) return;
    let cancelled = false;

    const load = async () => {
      try {
        const data = await fetchNotifications(sheetService, user?.email || '');
        if (cancelled) return;
        setNotifications((prev) => {
          const previousIds = new Set(prev.map((n) => n.id));
          const hasNew = data.some((n) => !previousIds.has(n.id));
          if (hasNew && data.length > 0) {
            playSound();
            vibrate();
          }
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          } catch (error) {
            console.warn('Failed to cache notifications:', error);
          }
          return data;
        });
      } catch (e) {
        console.warn('Failed to load notifications:', e);
      }
    };

    load();
    const interval = setInterval(load, 60000);
    const refreshListener = () => load();
    window.addEventListener('sheet-notifications-refresh', refreshListener as any);
    const onOnline = () => load();
    window.addEventListener('online', onOnline);
    return () => {
      cancelled = true;
      clearInterval(interval);
      window.removeEventListener('sheet-notifications-refresh', refreshListener as any);
      window.removeEventListener('online', onOnline);
    };
  }, [sheetService, user?.email]);

  const unreadCount = useMemo(() => notifications.filter((n) => !n.read).length, [notifications]);

  const handleToggle = async () => {
    const nextOpen = !open;
    setOpen(nextOpen);

    if (nextOpen && sheetService && unreadCount > 0 && !markingRead) {
      try {
        setMarkingRead(true);
        await markNotificationsAsRead(sheetService, notifications.filter(n => !n.read));
        const updatedNotifications = notifications.map((n) => ({ ...n, read: true }));
        setNotifications(updatedNotifications);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedNotifications));
      } catch (error) {
        console.warn('Failed to mark notifications as read:', error);
      } finally {
        setMarkingRead(false);
      }
    }
  };

  const handleClickNotification = async (n: AppNotification) => {
    // Mark as read locally and in sheet
    if (!n.read) {
      try {
        if (sheetService) await markNotificationsAsRead(sheetService as any, [n]);
        const updatedNotifications = notifications.map((x) => (x.id === n.id ? { ...x, read: true } : x));
        setNotifications(updatedNotifications);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedNotifications));
      } catch (error) {
        console.warn('Failed to mark notification as read:', error);
      }
    }

    // Route by type or message keywords
    const t = String(n.type || '').toLowerCase();
    const msg = String(n.message || '').toLowerCase();
    const isBlackboard = t.includes('blackboard') || msg.includes('blackboard') || msg.includes('announcement') || msg.includes('update');
    const isLead = t.includes('lead') || t.includes('assign') || t.includes('book') || msg.includes('lead') || msg.includes('assigned') || msg.includes('booking');

    if (n.leadId) {
      navigate(`/lead/${n.leadId}`);
    } else if (n.route && n.route.startsWith('/')) {
      navigate(n.route);
    } else if (isBlackboard) {
      navigate('/dashboard?view=analytics');
    } else if (isLead) {
      navigate('/');
    } else if (n.targetTravellerName || n.targetDateTime || n.targetTripId) {
      stateManager.setPendingTarget({ travellerName: n.targetTravellerName, dateAndTime: n.targetDateTime, tripId: n.targetTripId });
      navigate('/');
    } else if (n.message) {
      const key = extractSearchKey(n.message);
      stateManager.setFilters({ searchQuery: key });
      navigate('/');
    } else {
      const key = extractSearchKey(n.title || '');
      stateManager.setFilters({ searchQuery: key });
      navigate('/');
    }
    setOpen(false);
  };

  function extractSearchKey(text: string): string {
    const msg = text.trim();
    let key = '';
    // 1) Name inside quotes, e.g., Trip for "Ankush Kalekar" assigned to ...
    const mQuoted = msg.match(/"([^\"]{2,80})"/);
    if (mQuoted && mQuoted[1]) {
      key = mQuoted[1].trim();
    }
    // 2) for <name> assigned ... with optional quotes
    if (!key) {
      const mFor = msg.match(/\bfor\s+["']?([A-Za-z][A-Za-z\s.'-]{1,80})["']?\s+assigned\b/i);
      if (mFor && mFor[1]) key = mFor[1].trim();
    }
    // 3) <name> booked with us
    if (!key) {
      const mBooked = msg.match(/^([A-Za-z][A-Za-z\s.'-]{1,80})\s+booked\b/i);
      if (mBooked && mBooked[1]) key = mBooked[1].trim();
    }
    // 4) Fallback: first capitalized phrase (likely a name)
    if (!key) {
      const words = msg.split(/\s+/);
      const start = words.findIndex(w => /^[A-Z]/.test(w));
      if (start >= 0) key = words.slice(start, start + 3).join(' ').trim();
    }
    // Final fallback: avoid generic title like "Trip Assigned"
    if (!key) key = msg.replace(/[-â€“:]/g, ' ').trim();
    return key;
  }

  return (
    <div className="relative">
      <Tooltip>
        <TooltipTrigger asChild>
          <button
            type="button"
            onClick={handleToggle}
            className="relative flex items-center justify-center text-muted-foreground hover:text-foreground transition"
            aria-label={unreadCount > 0 ? `View ${unreadCount} notifications` : 'View notifications'}
          >
            <Bell className="cursor-pointer" />
            {unreadCount > 0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1">
                {unreadCount}
              </span>
            )}
          </button>
        </TooltipTrigger>
        <TooltipContent side="bottom" className="text-xs">
          {unreadCount > 0 ? `${unreadCount} new notification${unreadCount > 1 ? 's' : ''}` : 'All caught up'}
        </TooltipContent>
      </Tooltip>
      {open && (
        <div className="notification-panel w-72 max-h-[80vh] overflow-y-auto fixed right-4 top-16 bg-white dark:bg-slate-900 shadow-xl rounded-xl p-3 z-[9999] border border-slate-200 dark:border-slate-700">
          {notifications.length === 0 ? (
            <div className="text-xs text-muted-foreground">No new notifications</div>
          ) : (
            notifications.map((n) => (
              <button key={n.id} className="border-b py-1 last:border-0 text-left w-full" onClick={() => handleClickNotification(n)}>
                <p className="font-semibold flex items-center gap-2">
                  {n.title}
                  {n.read && <span className="text-[10px] text-muted-foreground uppercase">Viewed</span>}
                </p>
                <p className="text-sm text-muted-foreground">{n.message}</p>
                <div className="text-[10px] text-muted-foreground mt-1">{new Date(n.createdAt).toLocaleString()}</div>
              </button>
            ))
          )}
          <div className="pt-2 text-right">
            <button
              type="button"
              className="text-xs text-primary hover:underline"
              onClick={(e) => {
                try { e.preventDefault(); e.stopPropagation(); } catch {}
                setOpen(false);
                // Delay navigation slightly to allow panel to close in Android WebView
                setTimeout(() => {
                  try { navigate('/notifications'); } catch {}
                  try {
                    // Fallback for Android WebView + HashRouter
                    if (typeof window !== 'undefined') {
                      const expected = '#/notifications';
                      if (window.location && !String(window.location.hash || '').startsWith(expected)) {
                        window.location.hash = expected;
                      }
                    }
                  } catch {}
                }, 0);
              }}
              onTouchEnd={(e) => {
                try { e.preventDefault(); e.stopPropagation(); } catch {}
                setOpen(false);
                setTimeout(() => {
                  try { navigate('/notifications'); } catch {}
                  try {
                    const expected = '#/notifications';
                    if (typeof window !== 'undefined') {
                      if (!String(window.location.hash || '').startsWith(expected)) {
                        window.location.hash = expected;
                      }
                    }
                  } catch {}
                }, 0);
              }}
            >
              View all
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
